<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nesting Pie Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .input-container {
            margin-bottom: 10px;
        }
        .nested-input {
            margin-left: 20px;
        }
        canvas {
            display: block;
            margin: 20px auto;
        }
        #legendContainer {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Expense Tracker with Nested Subcategories</h1>
    <div id="inputArea">
        <div class="input-container">
            <input type="text" class="categoryInput" placeholder="Category" />
            <button class="addButton">+</button>
        </div>
    </div>
    <input type="number" id="amountInput" placeholder="Amount" />
    <button id="submitButton">Submit</button>
    
    <canvas id="mainPieChart" width="400" height="400"></canvas>
    <div id="legendContainer"></div>

    <script>
        const inputArea = document.getElementById('inputArea');
        const amountInput = document.getElementById('amountInput');
        const submitButton = document.getElementById('submitButton');
        const mainPieChartCanvas = document.getElementById('mainPieChart');
        const legendContainer = document.getElementById('legendContainer');
        
        let mainCategories = {};
        let mainPieChart;

        function updateMainPieChart() {
            const data = {
                labels: Object.keys(mainCategories),
                datasets: [{
                    label: 'Expenses',
                    data: Object.values(mainCategories).map(cat => cat.total),
                    backgroundColor: Object.values(mainCategories).map(cat => cat.color),
                }]
            };

            if (mainPieChart) {
                mainPieChart.data = data;
                mainPieChart.update();
            } else {
                mainPieChart = new Chart(mainPieChartCanvas, {
                    type: 'pie',
                    data: data,
                    options: {
                        onClick: (evt) => {
                            const activePoints = mainPieChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
                            if (activePoints.length) {
                                const chartIndex = activePoints[0].index;
                                const category = data.labels[chartIndex];
                                renderSubChart(category);
                            }
                        }
                    }
                });
            }

            // Render the legend
            renderLegend(data);
        }

        function renderLegend(data) {
            legendContainer.innerHTML = '';
            data.labels.forEach((label, index) => {
                const legendItem = document.createElement('div');
                legendItem.style.color = data.datasets[0].backgroundColor[index];
                legendItem.textContent = `${label}: ${data.datasets[0].data[index]}`;
                legendContainer.appendChild(legendItem);
            });
        }

        function addSubCategoryInput(parentElement) {
            const subInputContainer = document.createElement('div');
            subInputContainer.className = 'nested-input';

            const subcategoryInput = document.createElement('input');
            subcategoryInput.type = 'text';
            subcategoryInput.placeholder = 'Subcategory';

            const subButton = document.createElement('button');
            subButton.innerText = '+';

            subInputContainer.appendChild(subcategoryInput);
            subInputContainer.appendChild(subButton);
            parentElement.appendChild(subInputContainer);

            subButton.addEventListener('click', () => addSubCategoryInput(subInputContainer));
        }

        inputArea.addEventListener('click', (event) => {
            if (event.target.classList.contains('addButton')) {
                addSubCategoryInput(event.target.parentElement);
            }
        });

        submitButton.addEventListener('click', () => {
            const categoryInputs = Array.from(document.querySelectorAll('.categoryInput'));
            const amount = parseFloat(amountInput.value);

            categoryInputs.forEach(input => {
                const category = input.value.trim();
                if (category) {
                    if (!mainCategories[category]) {
                        mainCategories[category] = { total: 0, color: `hsl(${Math.random() * 360}, 100%, 70%)`, subcategories: {} };
                    }
                    mainCategories[category].total += amount;

                    const subCategoryInputs = Array.from(input.parentElement.querySelectorAll('.nested-input input'));
                    subCategoryInputs.forEach(subInput => {
                        const subcategory = subInput.value.trim();
                        if (subcategory) {
                            if (!mainCategories[category].subcategories[subcategory]) {
                                mainCategories[category].subcategories[subcategory] = { total: 0, color: `hsl(${Math.random() * 360}, 100%, 70%)` };
                            }
                            mainCategories[category].subcategories[subcategory].total += amount;
                        }
                    });
                }
            });

            amountInput.value = '';
            updateMainPieChart();
        });

        function renderSubChart(category) {
            const subCategories = mainCategories[category].subcategories;

            const subChartData = {
                labels: Object.keys(subCategories),
                datasets: [{
                    label: `${category} Expenses`,
                    data: Object.values(subCategories).map(sub => sub.total),
                    backgroundColor: Object.values(subCategories).map(sub => sub.color),
                }]
            };

            // Clear the existing pie chart and re-render
            mainPieChart.destroy();
            mainPieChart = new Chart(mainPieChartCanvas.getContext('2d'), {
                type: 'pie',
                data: subChartData,
                options: {
                    onClick: (evt) => {
                        const activePoints = mainPieChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
                        if (activePoints.length) {
                            const chartIndex = activePoints[0].index;
                            const subcategory = subChartData.labels[chartIndex];
                            // Here you can further nest subcategories if desired
                        }
                    }
                }
            });

            renderLegend(subChartData);
        }
    </script>
</body>
</html>
